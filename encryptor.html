<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NovaScript V3 - Stable Phantom</title>
    <style>
        :root {
            --bg-dark: #0f172a; --bg-medium: #1e293b; --bg-light: #334155;
            --text-light: #f1f5f9; --text-muted: #94a3b8; --accent: #10b981; /* Green accent for stable version */
            --accent-hover: #059669; --border-color: #334155; --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: var(--bg-dark); color: var(--text-light); padding: 40px 20px; }
        .card { width: 100%; max-width: 800px; background: var(--bg-medium); border-radius: var(--border-radius); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6); border: 1px solid var(--border-color); }
        .card-header { text-align: center; padding: 25px; border-bottom: 1px solid var(--border-color); background: linear-gradient(180deg, rgba(16, 185, 129, 0.1) 0%, rgba(0,0,0,0) 100%); }
        .card-header h1 { color: var(--text-light); font-weight: 700; letter-spacing: 1px; }
        .card-header span { font-size: 0.8rem; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        .card-body { padding: 30px; display: flex; flex-direction: column; gap: 25px; }
        .form-group label { display: block; margin-bottom: 10px; color: var(--text-muted); font-weight: 500; font-size: 0.9rem; }
        .input-toggle { display: flex; background-color: var(--bg-dark); border-radius: var(--border-radius); padding: 5px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .toggle-button { flex-grow: 1; padding: 10px; text-align: center; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.3s; color: var(--text-muted); }
        .toggle-button.active { background-color: var(--accent); color: #ffffff; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .input-area, .output-area { width: 100%; min-height: 200px; padding: 15px; background-color: var(--bg-dark); border: 1px solid var(--border-color); border-radius: var(--border-radius); color: var(--text-light); font-size: 0.85rem; resize: vertical; font-family: 'Consolas', 'Monaco', monospace; line-height: 1.5; }
        .input-area:focus, .output-area:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        #file-input-container { display: none; }
        .custom-file-input { display: block; width: 100%; padding: 40px; background-color: var(--bg-dark); border: 2px dashed var(--border-color); border-radius: var(--border-radius); text-align: center; cursor: pointer; transition: all 0.3s; }
        .custom-file-input:hover { background-color: #162032; border-color: var(--accent); }
        #file-status { font-size: 0.9em; color: var(--text-muted); margin-top: 10px; text-align: center; }
        .text-input { width: 100%; padding: 12px; background-color: var(--bg-dark); border: 1px solid var(--border-color); border-radius: var(--border-radius); color: var(--text-light); font-size: 1em; }
        .text-input:focus { outline: none; border-color: var(--accent); }
        .submit-btn { padding: 15px; border: none; border-radius: var(--border-radius); background-image: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); color: white; font-size: 1em; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; letter-spacing: 0.5px; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3); }
        #output-container { display: none; animation: fadeIn 0.5s ease; }
        .output-controls { display: flex; gap: 15px; margin-top: 15px; }
        .output-controls button { width: 100%; background: var(--bg-light); border: 1px solid var(--border-color); background-image: none; }
        .output-controls button:hover { background: var(--bg-medium); border-color: var(--accent); transform: none; box-shadow: none; }
        .status-message { text-align: center; margin-top: 10px; font-weight: 500; height: 20px; font-size: 0.9rem; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <form id="encrypt-form" class="card">
        <div class="card-header">
            <span>Code Protector</span>
            <h1>NOVA SCRIPT V3</h1>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>1. Source Input</label>
                <div class="input-toggle">
                    <div class="toggle-button active" id="toggle-text">Paste Code</div>
                    <div class="toggle-button" id="toggle-file">Upload File</div>
                </div>
                <div id="text-input-container">
                    <textarea id="script-input" class="input-area" placeholder="local a = 10&#10;print('Hello World')"></textarea>
                </div>
                <div id="file-input-container">
                    <input type="file" id="file-input" accept=".lua,.txt" style="display: none;">
                    <label for="file-input" class="custom-file-input">
                        <strong>Click to Choose File</strong><br>
                        <span style="font-size: 0.8em; color: var(--text-muted)">.lua or .txt files supported</span>
                    </label>
                    <div id="file-status">No file chosen</div>
                </div>
            </div>

            <div class="form-group">
                <label for="key-input">2. Security Key</label>
                <input type="text" id="key-input" class="text-input" placeholder="Enter a strong password..." required>
            </div>

            <button type="submit" class="submit-btn" id="encrypt-btn">OBFUSCATE SCRIPT</button>
            <div id="status" class="status-message"></div>

            <div id="output-container" class="form-group">
                <label for="script-output">3. Obfuscated Result</label>
                <textarea id="script-output" class="output-area" readonly></textarea>
                <div class="output-controls">
                    <button type="button" id="copy-btn" class="submit-btn">Copy to Clipboard</button>
                    <button type="button" id="download-btn" class="submit-btn">Download .lua</button>
                </div>
            </div>
        </div>
    </form>

    <script>
        // --- UI Setup ---
        const form = document.getElementById('encrypt-form');
        const fileInput = document.getElementById('file-input');
        const scriptInput = document.getElementById('script-input');
        const fileStatus = document.getElementById('file-status');
        const keyInput = document.getElementById('key-input');
        const statusDiv = document.getElementById('status');
        const outputContainer = document.getElementById('output-container');
        const scriptOutput = document.getElementById('script-output');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn');
        const toggleText = document.getElementById('toggle-text');
        const toggleFile = document.getElementById('toggle-file');
        const textContainer = document.getElementById('text-input-container');
        const fileContainer = document.getElementById('file-input-container');
        let inputMode = 'text';

        // --- NEW OBFUSCATION ENGINE (STABLE PHANTOM V3) ---
        
        // Helper: Generate confusing variable names (Il1l style)
        // Fixed: Removed Math.random() from loop to ensure consistency when called,
        // but we will generate static assignments anyway.
        const genVar = (id) => {
            const chars = ['I', 'l', '1'];
            let res = '';
            let n = id + 50; 
            while(n > 0) {
                res += chars[n % 3];
                n = Math.floor(n / 3);
            }
            // Add a prefix/suffix based on ID to ensure uniqueness but consistency
            return 'l' + res + 'I' + (id % 2 === 0 ? '1' : 'l');
        };

        const strToByte = (str) => {
            let bytes = [];
            for (let i = 0; i < str.length; i++) bytes.push(str.charCodeAt(i));
            return bytes;
        };

        const phantomObfuscate = (source, key) => {
            let cleanSource = source.trim(); 
            
            // 2. Generate Variable Names map - STATIC ASSIGNMENT (THE FIX)
            // We define them ONCE here so they don't change later.
            const V = {
                load: genVar(1),
                byte: genVar(2),
                char: genVar(3),
                table: genVar(4),
                key: genVar(5),
                res: genVar(7),
                chunk: genVar(8),
                temp: genVar(9),
                xor: genVar(10),
                env: genVar(11),
                checksum: genVar(20),  // Was causing error before
                decVal: genVar(30),    // Was causing error before
                junk1: genVar(99),
                junk2: genVar(100),
                junkStr: genVar(101)
            };

            // 3. Encryption Logic
            let encryptedBytes = [];
            let keyBytes = strToByte(key);
            let keyLen = keyBytes.length;
            let rollingKey = 0;
            
            for(let i = 0; i < keyBytes.length; i++) rollingKey += keyBytes[i];
            
            for (let i = 0; i < cleanSource.length; i++) {
                let charCode = cleanSource.charCodeAt(i);
                let currentKey = keyBytes[i % keyLen];
                let enc = (charCode + i) ^ (currentKey + (rollingKey % 255));
                rollingKey = (rollingKey + enc) % 255;
                encryptedBytes.push(enc);
            }

            // 4. Generate Junk/Decoy Code
            const junkCode = `local ${V.junk1} = {}; local ${V.junk2} = function() return "${V.junkStr}" end;`;

            // 5. Construct the Lua Loader
            const luaTemplate = `
--[[ NovaScript V3 ]]
local ${V.env} = _G or getfenv()
local ${V.byte} = string.byte
local ${V.char} = string.char
local ${V.table} = {${encryptedBytes.join(',')}}
local ${V.key} = "${key}"
local ${V.res} = {}
local ${V.xor} = function(a,b) 
    local p,c=1,0 
    while a>0 and b>0 do 
        local ra,rb=a%2,b%2 
        if ra~=rb then c=c+p end 
        a,b,p=(a-ra)/2,(b-rb)/2,p*2 
    end 
    if a<b then a=b end 
    while a>0 do 
        local ra=a%2 
        if ra>0 then c=c+p end 
        a,p=(a-ra)/2,p*2 
    end 
    return c 
end

local ${V.checksum} = 0
for i=1, #${V.key} do ${V.checksum} = ${V.checksum} + ${V.byte}(${V.key}, i) end

for i=1, #${V.table} do
    local ${V.chunk} = ${V.table}[i]
    local ${V.temp} = ${V.byte}(${V.key}, (i-1)%#${V.key}+1)
    
    -- Decryption Logic
    local ${V.decVal} = ${V.xor}(${V.chunk}, ${V.temp} + (${V.checksum}%255))
    ${V.decVal} = ${V.decVal} - (i-1)
    
    -- Check negative overflow
    while ${V.decVal} < 0 do ${V.decVal} = ${V.decVal} + 256 end
    
    table.insert(${V.res}, ${V.char}(${V.decVal} % 256))
    
    ${V.checksum} = (${V.checksum} + ${V.chunk}) % 255
end

${junkCode}

local ${V.load} = (loadstring or load)(table.concat(${V.res}))
if ${V.load} then ${V.load}() else print("NovaError: Execution Failed") end
`;
            return luaTemplate;
        };

        // --- Event Listeners ---
        toggleText.addEventListener('click', () => {
            inputMode = 'text';
            textContainer.style.display = 'block';
            fileContainer.style.display = 'none';
            toggleText.classList.add('active');
            toggleFile.classList.remove('active');
        });
        
        toggleFile.addEventListener('click', () => {
            inputMode = 'file';
            textContainer.style.display = 'none';
            fileContainer.style.display = 'block';
            toggleFile.classList.add('active');
            toggleText.classList.remove('active');
        });

        fileInput.addEventListener("change", () => {
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileStatus.textContent = file.name;
                fileStatus.style.color = 'var(--text-light)';
            }
        });

        form.addEventListener("submit", (event) => {
            event.preventDefault();
            const key = keyInput.value;
            if (!key) return showStatus("Encryption key required!", true);

            if (inputMode === 'text') {
                const scriptContent = scriptInput.value;
                if (!scriptContent.trim()) return showStatus("No script provided!", true);
                process(scriptContent, key, "encrypted.lua");
            } else {
                const file = fileInput.files[0];
                if (!file) return showStatus("No file selected!", true);
                const reader = new FileReader();
                reader.readAsText(file);
                reader.onload = () => process(reader.result, key, "encrypted_" + file.name);
            }
        });

        const process = (content, key, filename) => {
            try {
                const result = phantomObfuscate(content, key);
                scriptOutput.value = result;
                outputContainer.style.display = 'block';
                downloadBtn.setAttribute('data-filename', filename);
                showStatus("Script obfuscated successfully.", false);
            } catch (e) {
                showStatus("Error: " + e.message, true);
            }
        };
        
        const showStatus = (msg, err) => {
            statusDiv.textContent = msg;
            statusDiv.style.color = err ? '#ef4444' : '#10b981';
        };

        copyBtn.addEventListener('click', () => {
            scriptOutput.select();
            document.execCommand('copy');
            showStatus("Copied to clipboard!", false);
        });

        downloadBtn.addEventListener('click', () => {
            const blob = new Blob([scriptOutput.value], { type: "text/plain;charset=utf-8" });
            const href = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = href;
            a.download = downloadBtn.getAttribute('data-filename');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    </script>
</body>
</html>
