<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { font-family: 'Inter', ui-sans-serif, system-ui; background-color: #f9fafb; }
      .admin-card { background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
      .accent-btn { background-color: #1e3a8a; }
      .accent-btn:hover { background-color: #172554; }
    </style>
</head>
<body class="p-8">

    <div class="admin-card p-8 w-full max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-10 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-900">Admin Panel</h1>
            <button id="logoutBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-200 text-sm">
                Log Out
            </button>
        </div>
    </div>

    <div class="admin-card p-8 w-full max-w-5xl mx-auto mt-8">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">1. Script Management</h2>
        <form id="scriptForm" class="space-y-4">
            <div>
                <label for="scriptTitle" class="block text-sm font-medium text-gray-700">Script Title</label>
                <input type="text" id="scriptTitle" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>
            <div>
                <label for="scriptDescription" class="block text-sm font-medium text-gray-700">Description</label>
                <input type="text" id="scriptDescription" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>
            <div>
                <label for="scriptFile" class="block text-sm font-medium text-gray-700">Upload Script File (.lua / .txt)</label>
                <input type="file" id="scriptFile" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">
                Upload & Create Script
            </button>
        </form>
        <p id="scriptMessage" class="mt-4 text-center text-sm"></p>
        
        <div id="adminScriptsList" class="space-y-4 mt-8 pt-4 border-t">
            <h3 class="font-semibold text-gray-700">Existing Scripts</h3>
            <p>Loading scripts...</p>
        </div>
    </div>

    <div class="admin-card p-8 w-full max-w-5xl mx-auto mt-8">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">2. Manual Key Generation</h2>
        <form id="keyForm" class="space-y-4">
            <div>
                <label for="keyUserId" class="block text-sm font-medium text-gray-700">Target User ID (Optional)</label>
                <input type="text" id="keyUserId" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Supabase User ID (UUID) or leave blank for admin key">
            </div>
            <div>
                <label for="keyDuration" class="block text-sm font-medium text-gray-700">Duration (in seconds)</label>
                <input type="number" id="keyDuration" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 86400 for 1 day. Use 0 for unlimited." required>
            </div>
            <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">
                Generate Key
            </button>
        </form>
        <p id="keyMessage" class="mt-4 text-center text-sm"></p>
    </div>

    <div class="admin-card p-8 w-full max-w-5xl mx-auto mt-8">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">3. Manage All Keys</h2>
        <div id="adminKeysList" class="space-y-4">
            <p>Loading keys...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        let supabase;

        // --- Mockup/Placeholder for Supabase Storage functions ---
        async function uploadScriptFile(file) {
            console.log("Simulasi: Mengunggah file ke Supabase Storage...");
            return `scripts/latest/${file.name.replace(/\s/g, '_')}`;
        }
        // --- Akhir Mockup ---

        async function initAdmin() {
            const response = await fetch('/.netlify/functions/get-config');
            if (!response.ok) { alert('Error: Could not get Supabase keys.'); return; }
            const keys = await response.json();
            
            supabase = window.supabase.createClient(keys.supabaseUrl, keys.supabaseKey);

            if (!document.cookie.includes("adminLoggedIn=true")) {
                window.location.href = '/login-admin.html'; 
                return;
            }
            
            fetchAdminScripts();
            fetchAdminKeys();
        }

        // Script Management Logic (Simulasi upload)
        document.getElementById('scriptForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const scriptFile = document.getElementById('scriptFile').files[0];
            const scriptMessage = document.getElementById('scriptMessage');
            
            scriptMessage.textContent = 'Uploading file and creating script metadata...';
            
            const downloadPath = await uploadScriptFile(scriptFile);
            
            const response = await fetch('/.netlify/functions/create-script-metadata', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: document.getElementById('scriptTitle').value,
                    description: document.getElementById('scriptDescription').value,
                    download_path: downloadPath 
                })
            });
            
            const result = await response.json();
            if (response.ok) {
                scriptMessage.textContent = `Script submitted successfully! ID: ${result.scriptId}`;
                scriptMessage.className = 'mt-4 text-center text-sm text-green-600';
                form.reset();
                fetchAdminScripts();
            } else {
                scriptMessage.textContent = `Error: ${result.error || 'Failed to create script.'}`;
                scriptMessage.className = 'mt-4 text-center text-sm text-red-600';
            }
        });
        
        // NEW: Implementasi fungsi deleteScript
        async function deleteScript(scriptId) {
            if (!confirm(`Are you sure you want to delete script ID: ${scriptId}? File di Supabase Storage tidak dihapus.`)) {
                return;
            }
            
            const response = await fetch('/.netlify/functions/delete-script-metadata', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scriptId })
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                fetchAdminScripts(); // Refresh list
            } else {
                alert(`Failed to delete script: ${result.error || 'Unknown error'}`);
            }
        }

        async function fetchAdminScripts() {
            const adminScriptsList = document.getElementById('adminScriptsList');
            // FIX: Ensure 'id' is selected for delete function
            const { data: scripts, error } = await supabase.from('scripts').select('id, title, version, download_path').order('created_at', { ascending: false });
            
            if (error) { adminScriptsList.innerHTML = `<p class="text-red-500">Error fetching scripts.</p>`; return; }
            
            adminScriptsList.innerHTML = scripts.length === 0 
                ? `<p class="text-gray-500">No scripts created yet.</p>`
                : scripts.map(script => `
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg">
                        <div>
                            <h3 class="font-semibold">${script.title} (v${script.version})</h3>
                            <p class="text-sm text-gray-500">ID: ${script.id} | Path: ${script.download_path}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="deleteScript('${script.id}')" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-red-600">Delete</button>
                        </div>
                    </div>`).join('');
        }
        
        // Key Generation Logic (Manual Admin Key) - REVERTED LOGIC
        document.getElementById('keyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const keyMessage = document.getElementById('keyMessage');
            
            keyMessage.textContent = 'Generating key...';
            const response = await fetch('/.netlify/functions/admin-generate-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    duration: parseInt(document.getElementById('keyDuration').value, 10),
                    // REVERTED: Kembali mengirim user_id
                    user_id: document.getElementById('keyUserId').value || null 
                })
            });
            const result = await response.json();
            if (response.ok) {
                keyMessage.textContent = `Key generated: ${result.key}`;
                keyMessage.className = 'mt-4 text-center text-sm text-green-600';
                e.target.reset();
                fetchAdminKeys();
            } else {
                keyMessage.textContent = `Error: ${result.error}`;
                keyMessage.className = 'mt-t-4 text-center text-sm text-red-600';
            }
        });

        // NEW: Implementasi fungsi deleteKey
        async function deleteKey(keyId) {
            if (!confirm(`Are you sure you want to delete Key ID: ${keyId}?`)) {
                return;
            }
            
            const response = await fetch('/.netlify/functions/delete-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keyId })
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                fetchAdminKeys(); // Refresh list
            } else {
                alert(`Failed to delete key: ${result.error || 'Unknown error'}`);
            }
        }


        // Key Management Logic
        async function fetchAdminKeys() {
            const adminKeysList = document.getElementById('adminKeysList');
            // FIX: Tambahkan 'id' di select statement agar tombol delete berfungsi
            const { data: keys, error } = await supabase.from('script_keys').select('id, key_value, duration, created_at, is_active, user_id').order('created_at', { ascending: false });
            
            if (error) { adminKeysList.innerHTML = `<p class="text-red-500">Error fetching keys: ${error.message}</p>`; return; }
            
            adminKeysList.innerHTML = keys.length === 0
                ? `<p class="text-gray-500">No keys generated yet.</p>`
                : keys.map(key => {
                    let durationText = key.duration === 0 ? 'Unlimited' : `${key.duration / 86400} days`;
                    let statusClass = key.is_active ? 'text-green-600' : 'text-red-600';
                    let userText = key.user_id ? `User ID: ${key.user_id.substring(0, 8)}...` : 'ADMIN/Manual';

                    return `
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg">
                        <div>
                            <code class="font-semibold text-blue-800">${key.key_value}</code>
                            <p class="text-sm text-gray-500">Duration: ${durationText} | Status: <span class="${statusClass}">${key.is_active ? 'Active' : 'Inactive'}</span></p>
                            <p class="text-xs text-gray-500">${userText}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="deleteKey('${key.id}')" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-red-600">Delete</button>
                        </div>
                    </div>`;
                }).join('');
        }

        // General
        document.getElementById('logoutBtn').addEventListener('click', () => {
            document.cookie = "adminLoggedIn=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location.href = '/login-admin.html';
        });

        initAdmin();
    </script>
</body>
</html>