<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - NovaScript</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <header class="flex justify-between items-center mb-8 w-full max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold">NovaScript Dashboard</h1>
        <button id="logoutBtn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200">
            Log Out
        </button>
    </header>

    <div class="space-y-8 w-full max-w-4xl mx-auto">
        
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Admin Script (<span id="scriptTitle">Loading...</span>)</h2>
            <div class="bg-gray-100 p-4 rounded-md relative">
                <pre id="scriptContent" class="text-gray-800 whitespace-pre-wrap text-sm">Loading script...</pre>
                <button id="copyScriptBtn" class="absolute top-2 right-2 bg-blue-500 text-white text-xs font-semibold py-1 px-2 rounded hover:bg-blue-600">
                    Copy
                </button>
            </div>
            <p id="scriptMessage" class="text-sm mt-2 text-green-600 hidden">Copied!</p>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Your Keys</h2>
            <div id="keysList" class="space-y-4">
                <p>Loading keys...</p>
            </div>
        </div>
        
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        const keysList = document.getElementById('keysList');
        const logoutBtn = document.getElementById('logoutBtn');
        const scriptContentPre = document.getElementById('scriptContent');
        const scriptTitleSpan = document.getElementById('scriptTitle');
        const copyScriptBtn = document.getElementById('copyScriptBtn');
        const scriptMessage = document.getElementById('scriptMessage');
        let supabase;

        async function initAndAuth() {
            const configResponse = await fetch('/.netlify/functions/get-config');
            if (!configResponse.ok) { 
                alert('Error: Could not get Supabase keys.');
                window.location.href = '/login';
                return;
            }
            const keys = await configResponse.json();
            supabase = window.supabase.createClient(keys.supabaseUrl, keys.supabaseKey);

            // Check Supabase Auth session
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                window.location.href = '/login';
                return;
            }
            
            fetchUserData();
        }

        function formatDuration(seconds) {
            if (seconds === 0) return 'Unlimited';
            if (seconds < 60) return `${seconds} detik`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (minutes < 60) return `${minutes}m ${remainingSeconds}s`;
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return `${hours}j ${remainingMinutes}m ${remainingSeconds}s`;
        }

        async function fetchUserData() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = '/login';
                return;
            }

            // DIPERBAIKI: Kirim JWT Supabase sebagai header Authorization
            const response = await fetch('/.netlify/functions/fetch-user-data', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${session.access_token}` 
                }
            });

            if (response.status === 401) {
                // Jika fungsi mengembalikan 401, token tidak valid
                await supabase.auth.signOut();
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                keysList.innerHTML = `<p class="text-red-500">Error loading data. (Pastikan Netlify Function dan Env Vars sudah dikonfigurasi)</p>`;
                return;
            }

            const data = await response.json();
            const { keys, script } = data;
            
            // --- Script Display ---
            if (script) {
                scriptTitleSpan.textContent = script.title;
                scriptContentPre.textContent = script.content;
            } else {
                scriptTitleSpan.textContent = 'Belum Diunggah';
                scriptContentPre.textContent = 'Admin belum mengunggah script. Admin dapat mengunggah script dengan ID: latest-script.';
            }

            // --- Keys Display ---
            if (keys.length === 0) {
                keysList.innerHTML = `<p class="text-gray-500">Anda belum memiliki kunci.</p>`;
                return;
            }

            const now = new Date().getTime();
            
            const renderedKeys = keys.map(key => {
                const isActive = key.is_active;
                let statusText = 'Inactive';
                let statusColor = 'text-red-600';
                let durationText = formatDuration(key.duration);
                let expiryText = 'Tidak Pernah Kadaluarsa';
                let timeRemaining = 'N/A';
                
                if (isActive) {
                    if (key.duration === 0) {
                        statusText = 'Aktif (Unlimited)';
                        statusColor = 'text-green-600';
                    } else {
                        const createdAtTime = new Date(key.created_at).getTime();
                        const expiresAt = createdAtTime + key.duration * 1000;
                        const secondsLeft = Math.floor((expiresAt - now) / 1000);
                        
                        if (secondsLeft > 0) {
                            statusText = 'Aktif (Berjangka)';
                            statusColor = 'text-green-600';
                            timeRemaining = formatDuration(secondsLeft);
                            expiryText = `Kadaluarsa pada ${new Date(expiresAt).toLocaleString()}`;
                        } else {
                            statusText = 'Kadaluarsa';
                            statusColor = 'text-yellow-600';
                        }
                    }
                }
                
                return `
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg">
                        <div>
                            <code class="font-semibold text-blue-600">${key.key_value}</code>
                            <p class="text-sm text-gray-500">Note: ${key.note || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Durasi: ${durationText} | Status: <span class="${statusColor}">${statusText}</span></p>
                            ${key.duration > 0 && statusColor === 'text-green-600' ? `<p class="text-sm text-gray-500">Sisa Waktu: ${timeRemaining}</p>` : `<p class="text-sm text-gray-500">${expiryText}</p>`}
                        </div>
                    </div>`;
            }).join('');
            
            keysList.innerHTML = renderedKeys;
        }

        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = '/login';
        });
        
        copyScriptBtn.addEventListener('click', () => {
            const textToCopy = scriptContentPre.textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                scriptMessage.classList.remove('hidden');
                setTimeout(() => { scriptMessage.classList.add('hidden'); }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        });

        initAndAuth();
    </script>
</body>
</html>