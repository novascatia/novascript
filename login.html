<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Register - Nova Scripts</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', ui-sans-serif, system-ui; background-color: #f9fafb; }
        .form-container { max-width: 400px; }
        .input-field { border-color: #d1d5db; transition: border-color 0.2s; }
        .input-field:focus { border-color: #1e3a8a; box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.5); }
        .accent-btn { background-color: #1e3a8a; transition: background-color 0.2s; }
        .accent-btn:hover { background-color: #172554; }
        .message-box { padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem; }
        .error-message { background-color: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
        .success-message { background-color: #d1fae5; color: #059669; border: 1px solid #6ee7b7; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="form-container w-full bg-white p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Nova Scripts Access</h1>

        <form id="authForm" class="space-y-5">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input type="email" id="email" class="input-field mt-1 block w-full p-3 border rounded-lg focus:outline-none" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" class="input-field mt-1 block w-full p-3 border rounded-lg focus:outline-none" required>
            </div>
            
            <button type="submit" id="authButton" class="w-full accent-btn text-white font-semibold py-3 rounded-lg shadow-md transition-colors duration-200">
                Sign In
            </button>
        </form>

        <div id="message" class="message-box text-sm text-center hidden"></div>

        <div class="mt-6 pt-6 border-t border-gray-100 text-center">
            <p id="toggleText" class="text-sm text-gray-600">
                Don't have an account? 
                <button id="toggleAuthMode" class="text-blue-800 font-medium hover:underline focus:outline-none">Sign Up</button>
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        const authForm = document.getElementById('authForm');
        const authButton = document.getElementById('authButton');
        const messageDiv = document.getElementById('message');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
        let supabase;
        let isSignUpMode = false;

        async function initSupabase() {
            try {
                const response = await fetch('/.netlify/functions/get-config');
                if (!response.ok) throw new Error('Failed to get Supabase config.');
                
                const keys = await response.json();
                if (!keys.supabaseUrl || !keys.supabaseKey) throw new Error('Supabase keys are missing.');
                
                supabase = window.supabase.createClient(keys.supabaseUrl, keys.supabaseKey);
                
                // Cek status user saat ini
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    window.location.href = '/dashboard.html';
                }
            } catch (error) {
                displayMessage('Error initializing: Check Netlify ENV vars and deploy log.', 'error');
                console.error('Initialization Error:', error);
            }
        }

        function displayMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = `message-box text-sm text-center ${type}-message`;
            messageDiv.classList.remove('hidden');
        }

        function toggleMode() {
            isSignUpMode = !isSignUpMode;
            if (isSignUpMode) {
                authButton.textContent = 'Sign Up';
                toggleAuthModeBtn.textContent = 'Sign In';
                document.getElementById('toggleText').innerHTML = 'Already have an account? <button id="toggleAuthMode" class="text-blue-800 font-medium hover:underline focus:outline-none">Sign In</button>';
            } else {
                authButton.textContent = 'Sign In';
                toggleAuthModeBtn.textContent = 'Sign Up';
                document.getElementById('toggleText').innerHTML = "Don't have an account? <button id='toggleAuthMode' class='text-blue-800 font-medium hover:underline focus:outline-none'>Sign Up</button>";
            }
            // Re-attach event listener since innerHTML replaced the button
            document.getElementById('toggleAuthMode').addEventListener('click', toggleMode);
            messageDiv.classList.add('hidden'); // Clear previous messages
        }

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            authButton.disabled = true;
            authButton.textContent = isSignUpMode ? 'Registering...' : 'Logging In...';
            messageDiv.classList.add('hidden');

            try {
                let response;
                if (isSignUpMode) {
                    // --- SIGN UP ---
                    response = await supabase.auth.signUp({ email, password });
                    
                    if (response.error) {
                         // Tangkap error 422 di sini
                        throw response.error; 
                    }
                    
                    // Supabase by default requires email verification
                    if (response.data.user) {
                        displayMessage('Registration successful! Please check your email for a confirmation link.', 'success');
                    } else if (response.data.session) {
                        // Jika konfirmasi email dimatikan
                        displayMessage('Registration successful! Redirecting to dashboard...', 'success');
                        setTimeout(() => window.location.href = '/dashboard.html', 1500);
                    }
                    
                } else {
                    // --- SIGN IN ---
                    response = await supabase.auth.signInWithPassword({ email, password });
                    
                    if (response.error) {
                        throw response.error;
                    }

                    displayMessage('Login successful! Redirecting...', 'success');
                    setTimeout(() => window.location.href = '/dashboard.html', 1000);
                }

            } catch (error) {
                console.error('Auth Error:', error);
                // Menampilkan pesan error yang lebih jelas
                let errorMessage = 'An unknown error occurred.';
                if (error.message && error.message.includes('Password should be')) {
                    errorMessage = 'Password is too weak. Must be at least 6 characters.';
                } else if (error.message) {
                    errorMessage = error.message;
                } else if (error.json && error.json.msg) {
                     // Ini mungkin menangkap error 422 dari Network Tab jika ada
                    errorMessage = error.json.msg;
                }
                
                displayMessage(`Error: ${errorMessage}`, 'error');
            } finally {
                authButton.disabled = false;
                authButton.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            }
        });

        initSupabase();
        toggleAuthModeBtn.addEventListener('click', toggleMode);
    </script>
</body>
</html>
