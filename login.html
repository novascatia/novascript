<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Login / Register</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', ui-sans-serif, system-ui; background-color: #f9fafb; }
        .accent-btn { background-color: #1e3a8a; }
        .accent-btn:hover { background-color: #172554; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 md:p-10 rounded-xl shadow-2xl w-full max-w-md border border-gray-100">
        <h2 class="text-3xl font-bold mb-6 text-center text-gray-800" id="formTitle">Customer Login</h2>
        <a href="/" class="text-blue-600 hover:underline text-sm mb-4 block">‚Üê Back to Home</a>
        
        <form id="authForm" class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input type="email" id="email" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <button type="submit" id="submitBtn" class="w-full accent-btn text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 shadow-md">
                Log In
            </button>
        </form>

        <div id="message" class="mt-4 text-center text-sm"></div>
        
        <p class="mt-6 text-center text-sm">
            Don't have an account? 
            <button id="toggleAuth" class="text-blue-800 font-medium hover:underline">Register Here</button>
        </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        const formTitle = document.getElementById('formTitle');
        const authForm = document.getElementById('authForm');
        const submitBtn = document.getElementById('submitBtn');
        const toggleAuth = document.getElementById('toggleAuth');
        const messageDiv = document.getElementById('message');
        let isLogin = true;
        let supabase;

        async function initSupabase() {
            messageDiv.textContent = 'Initializing...';
            const response = await fetch('/.netlify/functions/get-config');
            if (!response.ok) {
                messageDiv.textContent = 'Error: Could not get Supabase keys.';
                return;
            }
            const keys = await response.json();
            // Inisialisasi Supabase
            supabase = window.supabase.createClient(keys.supabaseUrl, keys.supabaseKey);
            
            // Cek jika user sudah login
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                window.location.href = '/dashboard.html';
            }
            messageDiv.textContent = '';
        }

        toggleAuth.addEventListener('click', () => {
            isLogin = !isLogin;
            formTitle.textContent = isLogin ? 'Customer Login' : 'Customer Register';
            submitBtn.textContent = isLogin ? 'Log In' : 'Sign Up';
            toggleAuth.textContent = isLogin ? 'Register Here' : 'Log In Here';
            messageDiv.textContent = ''; // Clear message on toggle
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!supabase) { await initSupabase(); }

            messageDiv.textContent = 'Processing...';

            let response;
            if (isLogin) {
                // Login
                response = await supabase.auth.signInWithPassword({ email, password });
            } else {
                // Register
                response = await supabase.auth.signUp({ email, password });
            }

            if (response.error) {
                messageDiv.className = 'mt-4 text-center text-sm text-red-500';
                messageDiv.textContent = `Error: ${response.error.message}`;
            } else if (isLogin) {
                messageDiv.className = 'mt-4 text-center text-sm text-green-500';
                messageDiv.textContent = 'Login successful! Redirecting...';
                window.location.href = '/dashboard.html';
            } else {
                messageDiv.className = 'mt-4 text-center text-sm text-yellow-600';
                // Supabase biasanya mengirim email konfirmasi setelah Sign Up
                messageDiv.textContent = 'Registration successful! Please check your email to confirm your account before logging in.';
                // Ubah ke mode login setelah register
                isLogin = true;
                toggleAuth.click(); 
            }
        });

        initSupabase();
    </script>
</body>
</html>
