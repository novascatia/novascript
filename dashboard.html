<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Nova Scripts</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { font-family: 'Inter', ui-sans-serif, system-ui; background-color: #f9fafb; color: #1f2937; }
      .card {
          background-color: #ffffff;
          border: 1px solid #e5e7eb;
          border-radius: 0.75rem;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
          transition: transform 0.2s, box-shadow 0.2s;
      }
      .card:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .active-key { color: #10b981; font-weight: 600; }
      .expired-key { color: #f87171; font-weight: 600; }
      .accent-btn {
          background-color: #1e3a8a;
          transition: background-color 0.2s;
      }
      .accent-btn:hover {
          background-color: #172554;
      }
    </style>
</head>
<body class="p-8 md:p-12 min-h-screen">

    <header class="flex justify-between items-center mb-12 max-w-6xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900">nova<span class="text-blue-800">.scripts</span></h1>
        <div class="flex items-center space-x-4">
            <p class="text-gray-600 hidden sm:block">Welcome, <span id="userName" class="font-semibold text-gray-800">Customer</span></p>
            <button id="logoutBtn" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-200 text-sm">
                Log Out
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">Your Access Keys</h2>
            <a href="/purchase.html" class="accent-btn text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm">
                Purchase New Access
            </a>
        </div>

        <div id="keysList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p class="text-gray-500 col-span-full">Loading your keys...</p>
        </div>
        
        <div id="scriptsSection" class="mt-16">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Available Scripts</h2>
            <div id="scriptsList" class="space-y-4">
                <p class="text-gray-500 p-4 bg-white rounded-lg border">Loading script metadata...</p>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        let supabase;

        async function init() {
            const response = await fetch('/.netlify/functions/get-config');
            if (!response.ok) { console.error('Error: Could not get Supabase keys.'); return; }
            const keys = await response.json();
            supabase = window.supabase.createClient(keys.supabaseUrl, keys.supabaseKey);

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = '/login.html';
                return;
            }
            document.getElementById('userName').textContent = user.email ? user.email.split('@')[0] : 'Customer';
            
            fetchUserKeys(user.id);
            fetchAvailableScripts();
        }

        async function fetchUserKeys(userId) {
            const keysList = document.getElementById('keysList');
            keysList.innerHTML = '';
            
            // Asumsi: key terhubung ke user ID dari skema Supabase yang sudah kita buat.
            const { data: keys, error } = await supabase
                .from('script_keys')
                .select('key_value, duration, created_at, is_active, note')
                .eq('user_id', userId) 
                .order('created_at', { ascending: false });

            if (error) {
                keysList.innerHTML = `<p class="text-red-500 col-span-full card p-6">Error fetching keys: ${error.message}</p>`;
                return;
            }

            if (keys.length === 0) {
                keysList.innerHTML = `<p class="text-gray-500 col-span-full py-4 px-6 bg-white border border-gray-200 rounded-lg">You don't have any active keys. <a href="/purchase.html" class="text-blue-800 hover:underline font-medium">Purchase one now!</a></p>`;
                return;
            }

            keysList.innerHTML = keys.map(key => {
                let durationText = key.duration === 0 ? 'Unlimited' : `${key.duration / 86400} Days`;
                let statusClass = key.is_active ? 'active-key' : 'expired-key';
                let statusText = key.is_active ? 'Active' : 'Expired/Inactive';
                
                let expiresInfo = 'Never expires';
                if (key.duration > 0) {
                    const expiresAt = new Date(new Date(key.created_at).getTime() + key.duration * 1000);
                    expiresInfo = `Expires on ${expiresAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}`;
                    if (new Date() > expiresAt && key.is_active) { 
                       // Frontend check, perlu cron job di backend untuk status pasti
                       statusText = 'Expired';
                       statusClass = 'expired-key';
                    }
                }
                
                return `
                    <div class="card p-6">
                        <p class="text-sm font-medium text-gray-500 mb-1">Key Value</p>
                        <code class="text-xl font-mono break-all text-blue-800 select-all">${key.key_value}</code>
                        <div class="mt-4 text-sm space-y-1">
                            <p class="text-gray-700">Duration: <span class="font-medium">${durationText}</span></p>
                            <p class="text-gray-700">Status: <span class="${statusClass}">${statusText}</span></p>
                            <p class="text-gray-500 text-xs">${expiresInfo}</p>
                            <p class="text-gray-500 text-xs">Note: ${key.note || 'N/A'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function fetchAvailableScripts() {
            const scriptsList = document.getElementById('scriptsList');
            // Endpoint baru untuk fetch metadata script
            const response = await fetch('/.netlify/functions/fetch-scripts-metadata'); 
            if (!response.ok) {
                scriptsList.innerHTML = `<p class="text-red-500 p-4 bg-white rounded-lg border">Error loading script metadata.</p>`;
                return;
            }
            
            const scripts = await response.json();
            scriptsList.innerHTML = scripts.length === 0 
                ? `<p class="text-gray-500 p-4 bg-white rounded-lg border">No scripts are available right now.</p>`
                : scripts.map(script => `
                    <div class="flex justify-between items-center card p-5 shadow-sm">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">${script.title}</h3>
                            <p class="text-sm text-gray-500 mt-1">${script.description} (v${script.version})</p>
                        </div>
                        <button onclick="downloadScript('${script.id}')" class="bg-gray-800 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm shadow-md">
                            Download
                        </button>
                    </div>
                `).join('');
        }

        function downloadScript(scriptId) {
            // Ini hanyalah simulasi, pengguna harus memiliki key aktif yang valid.
            alert(`Download initiated for Script ID: ${scriptId}. Please ensure you have an active key. The script will request your key.`);
            // Alamat skrip Lua/software Anda akan mengakses endpoint ini:
            // https://yourdomain.com/.netlify/functions/download-script?id=${scriptId}&key=USER_ACTIVE_KEY
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
        });

        init();
    </script>
</body>
</html>
