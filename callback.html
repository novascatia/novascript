<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Auth...</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', ui-sans-serif, system-ui; background-color: #f9fafb; }
        .success-box { background-color: #d1fae5; color: #059669; border: 1px solid #6ee7b7; }
        .error-box { background-color: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="max-w-md w-full p-8 rounded-xl shadow-2xl bg-white text-center">
        <h1 class="text-2xl font-bold text-gray-800 mb-4" id="statusTitle">Processing Authentication...</h1>
        <div id="messageBox" class="p-4 rounded-lg text-sm">
            Please wait while we secure your session.
        </div>
        <p class="mt-6 text-gray-500 text-sm" id="redirectText"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        const messageBox = document.getElementById('messageBox');
        const statusTitle = document.getElementById('statusTitle');
        const redirectText = document.getElementById('redirectText');
        let supabase;

        async function initAndHandleAuth() {
            try {
                // 1. Inisialisasi Supabase
                const response = await fetch('/.netlify/functions/get-config');
                if (!response.ok) throw new Error('Failed to get Supabase config.');
                
                const keys = await response.json();
                supabase = window.supabase.createClient(keys.supabaseUrl, keys.supabaseKey);

                // 2. Periksa apakah ada token dalam URL (dari email konfirmasi)
                // Supabase secara otomatis menangani session dari URL hash/query params
                
                statusTitle.textContent = "Verifying Account...";
                messageBox.className = "p-4 rounded-lg text-sm"; // Bersihkan kelas

                // 3. Tambahkan listener untuk mendeteksi perubahan status auth
                // Ini akan terpicu setelah Supabase memproses token dari URL
                const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        statusTitle.textContent = "Success! Account Confirmed.";
                        messageBox.textContent = "You are now logged in and verified.";
                        messageBox.className = "p-4 rounded-lg success-box text-sm";
                        
                        redirectText.textContent = "Redirecting to your Dashboard in 3 seconds...";
                        subscription.unsubscribe(); // Hentikan listener
                        
                        setTimeout(() => {
                            window.location.href = '/dashboard.html';
                        }, 3000);
                        
                    } else if (event === 'SIGNED_OUT') {
                        // Ini terjadi jika tidak ada session yang ditemukan atau session kadaluarsa
                        statusTitle.textContent = "Authentication Failed";
                        messageBox.textContent = "Failed to verify session. Please return to the login page.";
                        messageBox.className = "p-4 rounded-lg error-box text-sm";
                        redirectText.innerHTML = '<a href="/login.html" class="text-blue-800 font-medium hover:underline">Go to Login Page</a>';
                        subscription.unsubscribe();
                    }
                });

            } catch (error) {
                console.error('Callback Error:', error);
                statusTitle.textContent = "Error Occurred";
                messageBox.textContent = `A critical error occurred: ${error.message}`;
                messageBox.className = "p-4 rounded-lg error-box text-sm";
                redirectText.innerHTML = '<a href="/login.html" class="text-blue-800 font-medium hover:underline">Go to Login Page</a>';
            }
        }

        initAndHandleAuth();
    </script>
</body>
</html>
